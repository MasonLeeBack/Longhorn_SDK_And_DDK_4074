<package>
    <job id="checkah" prompt="no">
	<runtime>
	        <description>This script tests the AH offloaded on the card.</description>
	        <named
			name="IP"
		 	helpstring= "IP of the Machine to Test"
			type = "string"
			required="true"
		/>
		<named
		        name="AH"
		        helpstring= "AH algo to use"
		        type = "string"
		        required="true"
		/>
		<example>Example: checkah.wsf /IP:200.1.1.1 /AH:MD5</example>
	</runtime>
	

	
        <reference object="NDInfo.Info.1" version="1.0"/>
        <reference id="NDTSupp" object="NDTSupp.SuppCore.1" version="1.0"/>
        <reference object="NDTCore.base.1" version="1.0"/>
        <object id="oNDTSupp" progid="NDTSupp.Support.1" events="true"/>
        <object id="oNDInfo" progid="NDInfo.Info.1" events="true"/>
        <object id="oSuppCore" progid="NDTSupp.SuppCore.1" events="true"/>
        <object id="oNDTCore" progid="NDTCore.base.1" events="true"/>
        <object id="oNDTSession" progid="NDTSession.Session.1" events="true"/>
        <script language="VBScript" src="..\inc\clog.vbs"/>
        <script language="VBScript" src="..\inc\ccard.vbs"/>
        <script language="VBScript" src="..\inc\copen.vbs"/>
        <script language="VBScript" src="..\inc\general.vbs"/>
        <script id="checkah" language="VBScript">
'==========================================================================
' Script Name:   checkah 
'==========================================================================
Option Explicit 


'Should not reinitialize since the variables are already initialized 
'in the parent script
'You onlu need to create CLog object seperately.
'Call Initialize ()
Call Main ()
'Call Terminate ()

Function Main

'--------------------------------------------------------------------------
Dim pAdapterList                 ' List obtained from oNDInfo
Dim oClientCard, oSupportCard
Dim Offloadable , Offload_Failed , Offloaded , Status 
Dim IPAddr, MacAddr
Dim AH_Integrity
Dim idx, pIP,pMac
Dim Adapter
Dim oLog


'==========================================================================
'++++++++++++++++++++++++++++ BEGIN TEST ++++++++++++++++++++++++++++++++++
'==========================================================================
Offloaded = False
Offloadable = False
Offload_Failed = False
Status = False


Set oLog = new CLog

oNDTCore.LogPtr = oLog.LogPtr

'
' Get Adapter collection from UI Object
'
Set pAdapterList = oNDInfo.AdapterList 


' From the Collection look for the IP address matching our criteria (input) and 
' query for the AH offload
'



For Each Adapter in pAdapterList
	if(Adapter.AdapterType = ADAPTERTYPE_TEST OR Adapter.AdapterType = ADAPTERTYPE_SUPPORT) then
		IPAddr = Adapter.IPAddress
				
		if ( IPAddr = WScript.Arguments.Named("IP"))  Then

			set oSupportCard = oNDTCore.CreateAdapterSilent(Adapter)
		
			If(oSupportCard is Nothing) Then
	   			call oLog.Failed ("Failed to create Support adapter object!" , 20968)
	   			Set pAdapterList = Nothing
	   			Set oSupportCard = Nothing
	   			Exit Function
			End If
		
	
			if (WScript.Arguments.Named("AH") = "NONE") then
				pIP = "AH[NONE] on IP "
				AH_Integrity = 0 
			end if
	
	
	
			if (WScript.Arguments.Named("AH") = "MD5") then
				pIP = "AH[MD5] on IP "
				AH_Integrity = 1
			end if
	
	
			if (WScript.Arguments.Named("AH") = "SHA") then
				AH_Integrity = 2
				pIP = "AH[SHA] on IP "
			end if
	
	
			
			Status = oSupportCard.QueryIPSecDriverAH (AH_Integrity,Offloaded,Offload_Failed,Offloadable)
			pIP = pIP + IPAddr	
			oLog.Write (pIP)


' Offload status Logs

			if (Offloadable) then 
				oLog.Write "- SA Offloadable"

				if (Offloaded) then 
					oLog.Write "- SA Offloaded"
				else
					oLog.Write "- SA not Offloaded"
				end if
	
				if (Offload_Failed) then 
					oLog.Failed "- SA Offload Failed",88888
				end if
				
			else
				oLog.Write "- SA not Offloadable"
			end if
	
			Exit For

			
		End If
	End If

Next


' cleanup
'
' The closing of all the open handles is taken care of by the dll.
'
Set pAdapterList = Nothing
Set oSupportCard = Nothing

'
'
'==========================================================================
'++++++++++++++++++++++++++++  END TEST  ++++++++++++++++++++++++++++++++++
'==========================================================================
End Function	'Main ()

        </script>
    </job>
</package>

<!--- CRC = 0xd8bf3827 --->